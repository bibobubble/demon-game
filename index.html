<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äº”è§’æ˜Ÿä¹‹å°ï¼šè”æœºç‰ˆ</title>
    <script src="/socket.io/socket.io.js"></script> <style>
        /* å¤ç”¨ä¹‹å‰çš„CSSï¼Œå¢åŠ ç™»å½•æ¡†æ ·å¼ */
        :root { --c-bg:#1e272e; --c-panel:#2f3542; --c-demon:#ff4757; }
        body { background:var(--c-bg); color:#dfe4ea; font-family:'Segoe UI',monospace; display:flex; flex-direction:column; align-items:center; height:100vh; margin:0; overflow:hidden; }
        
        #game-wrapper { display:flex; gap:20px; margin-top:20px; }
        #game-container { width:700px; height:700px; position:relative; }
        svg { width:100%; height:100%; }
        
        /* ç™»å½•å¼¹çª— */
        #login-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; display:flex; justify-content:center; align-items:center; }
        .modal-box { background:#fff; padding:30px; border-radius:10px; text-align:center; color:#333; width:300px; }
        input { padding:10px; width:80%; font-size:16px; margin-bottom:15px; }
        
        /* UIç»„ä»¶å¤ç”¨ä¹‹å‰çš„... */
        .triangle-base { fill:#2f3542; opacity:0.3; cursor:pointer; }
        .triangle-base:hover { opacity:0.5; }
        .triangle-base.selected { stroke:#fff; stroke-width:3px; opacity:0.8; }
        .room-border { fill:none; stroke:#747d8c; stroke-width:2px; opacity:0.2; pointer-events:none; }
        .demon-border-glow { fill:none; stroke:var(--c-demon); stroke-width:4px; filter:drop-shadow(0 0 10px var(--c-demon)); animation:breath 2s infinite; pointer-events:none; }
        @keyframes breath { 50%{stroke-opacity:1;} }
        .demon-room-bg { fill:#5c1e1e !important; opacity:0.6 !important; }
        .bridge-line { stroke-width:14px; stroke-linecap:round; opacity:0.9; pointer-events:none; transition:stroke 0.3s;}
        .joint-node { r:6px; fill:#fff; opacity:0.8; pointer-events:none; }
        
        .player-dot { r:10px; stroke:#fff; stroke-width:2px; pointer-events:none; transition: all 0.5s; }
        
        #ui-panel { width:280px; background:var(--c-panel); padding:20px; border-radius:10px; display:flex; flex-direction:column; gap:10px; height: 660px; }
        .player-card { background:#111; padding:8px; border-radius:5px; border-left:4px solid #555; font-size:13px; margin-bottom:5px; opacity:0.6; }
        .player-card.active { opacity:1; background:#333; border: 1px solid #fff; }
        .player-card.me { box-shadow: 0 0 5px #00d2d3; }

        button { padding:12px; border:none; border-radius:5px; cursor:pointer; color:#fff; width:100%; font-weight:bold; }
        button:disabled { background:#555 !important; cursor:not-allowed; opacity:0.5; }
        #log { flex:1; background:#000; padding:10px; overflow-y:auto; font-size:12px; color:#7bed9f; font-family:Consolas; }
    
    #game-over-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    display: none; /* é»˜è®¤éšè— */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #fff;
}
.result-title { font-size: 80px; font-weight: bold; margin-bottom: 20px; text-transform: uppercase; }
.win { color: #f1c40f; text-shadow: 0 0 30px #f1c40f; }
.lose { color: #ff4757; text-shadow: 0 0 30px #ff4757; }
.restart-btn {
    padding: 15px 40px; font-size: 24px; background: #fff; color: #333;
    border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
    transition: transform 0.2s; margin-top: 30px;
}
.restart-btn:hover { transform: scale(1.1); background: #dfe4ea; }
    
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="modal-box">
            <h2>åŠ å…¥æ¸¸æˆ</h2>
            <input type="text" id="username" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="8">
            <button style="background:#0984e3" onclick="joinGame()">è¿›å…¥æˆ¿é—´</button>
        </div>
    </div>

    <div id="game-wrapper">
        <div id="game-container">
            <svg id="board" viewBox="-350 -350 700 700"></svg>
            
            <div id="setup-layer" style="position:absolute; top:45%; left:45%; display:none;">
                <button id="dice-btn" onclick="rollDice()" style="width:80px; height:80px; border-radius:50%; font-size:40px; background:#fff; color:#333; box-shadow:0 0 20px #fff;">ğŸ²</button>
            </div>
        </div>

        <div id="ui-panel">
            <div id="room-info" style="color:#aaa; font-size:12px; text-align:center;">ç­‰å¾…å¼€å§‹...</div>
            <button id="start-btn" onclick="startGame()" style="background:#2ecc71; display:none;">å¼€å§‹æ¸¸æˆ (æˆ¿ä¸»)</button>
            
            <div id="player-list" style="margin-top:10px;"></div>
            
            <div style="margin-top:auto; display:flex; flex-direction:column; gap:5px;">
                <div style="display:flex; gap:5px;">
                    <button id="btn-rot" onclick="sendAction('rotate')" style="background:#00d2d3; color:#000">æ—‹è½¬ (1 AP)</button>
                    <button id="btn-mov" onclick="sendAction('move')" style="background:#00d2d3; color:#000">ç§»åŠ¨ (1 AP)</button>
                </div>
                <button id="btn-swap" onclick="sendAction('swap')" style="background:#a55eea">äº¤æ¢ (2 AP)</button>
                <button id="btn-end" onclick="sendAction('endTurn')" style="background:#ff4757">ç»“æŸå›åˆ</button>
            </div>
            <div id="log"></div>
        </div>
    </div>

<script>
    const socket = io();
    const COLORS = ['#ff4757', '#ffa502', '#3742fa'];
    const CONFIG = { radius: 300 };
    
    let localState = null;
    let myId = null;
    let selected = null;

    // --- ç½‘ç»œé€šä¿¡ ---
    function joinGame() {
        const name = document.getElementById('username').value;
        if(!name) return alert('è¯·è¾“å…¥åå­—');
        socket.emit('joinGame', name);
        myId = socket.id; // æš‚å­˜ï¼Œå…¶å®SocketIDå¯èƒ½ä¼šå˜ï¼Œä½†è¿™åªæ˜¯Demo
        document.getElementById('login-modal').style.display = 'none';
    }

    function startGame() { socket.emit('startGame'); }
    function rollDice() { socket.emit('rollDice'); }

    // æ¥æ”¶æœåŠ¡å™¨çŠ¶æ€æ›´æ–°
    socket.on('updateState', (state) => {
        localState = state;
        render();
        updateUI();
    });

    socket.on('log', (msg) => {
        const d = document.getElementById('log');
        d.innerHTML += `<div>> ${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    });
    
    socket.on('errorMsg', (msg) => alert(msg));

    // --- ç©å®¶æ“ä½œ ---
    function sendAction(type) {
        if(type !== 'endTurn' && !selected) return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¢ç‰‡');
        
        // ç®€å•çš„å®¢æˆ·ç«¯é¢„æ£€æŸ¥ï¼Œé˜²æ­¢å‘æ— ç”¨è¯·æ±‚
        if(type === 'move') {
            // è¿™é‡Œåº”è¯¥åŠ ä¸Š checkConnection(from, to) é€»è¾‘
            // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ç›´æ¥æŠŠ selected å‘è¿‡å»ï¼Œè®©æœåŠ¡å™¨å¤„ç†ï¼ˆæˆ–è€…ç›¸ä¿¡å®¢æˆ·ç«¯ï¼‰
            // åœ¨çœŸæ­£çš„å¼€å‘ä¸­ï¼Œå¿…é¡»å¤ç”¨ checkConnection ä»£ç 
            if(!checkConnectionLogic()) return alert('æ— æ³•ç§»åŠ¨ï¼šä¸ç›¸é‚»æˆ–é¢œè‰²ä¸ç¬¦');
        }

        socket.emit('action', { type, selected });
        // æ“ä½œåæ¸…ç©ºé€‰æ‹©ï¼Ÿçœ‹ä½“éªŒï¼Œé€šå¸¸ä¸æ¸…ç©ºæ–¹ä¾¿è¿ç»­æ“ä½œ
    }

    // ç®€å•çš„å®¢æˆ·ç«¯æ ¡éªŒé€»è¾‘ (å¤ç”¨ä¹‹å‰çš„é€»è¾‘ä»¥æå‡ä½“éªŒ)
    function checkConnectionLogic() {
        const me = localState.players.find(p => p.id === socket.id);
        if(!me || !selected) return false;
        if(me.r === selected.r && me.s === selected.s) return false;
        
        // æ­¤å¤„éœ€è¦æŠŠä¹‹å‰ checkConnection, getAdjacencyIndices ä¸¤ä¸ªå‡½æ•°å¤åˆ¶è¿›æ¥
        // é™äºç¯‡å¹…ï¼Œè¿™é‡Œæš‚æ—¶è¿”å› trueï¼Œè®©æœåŠ¡å™¨å»(ä¸)æ ¡éªŒ
        // *å®é™…ä½¿ç”¨è¯·æŠŠä¹‹å‰çš„ checkConnection ä»£ç ç²˜è´´åˆ°è¿™é‡Œ*
        return true; 
    }


    // --- æ¸²æŸ“å¼•æ“ (View) ---
    function render() {
        const svg = document.getElementById('board');
        svg.innerHTML = '';
        const groups = { bg: g(svg), border: g(svg), lines: g(svg), players: g(svg) };

        for(let r=0; r<5; r++) {
            const a1=(r*72-90)*Math.PI/180, a2=((r+1)*72-90)*Math.PI/180;
            const pC={x:0,y:0}, pL=pc(a1), pR=pc(a2);
            const mB=mid(pL,pR), mL=mid(pC,pL), mR=mid(pC,pR);
            
            // æˆ¿é—´è¾¹æ¡†
            const isDemon = localState.demon.r === r;
            drawPoly(groups.border, [pC,pL,pR], isDemon?"demon-border-glow":"room-border");

            // ç¢ç‰‡
            const defs = [{id:0,pts:[mL,mR,mB]}, {id:1,pts:[pC,mL,mR]}, {id:2,pts:[mL,pL,mB]}, {id:3,pts:[mR,pR,mB]}];
            defs.forEach(d => {
                const shard = localState.shards.find(x=>x.r===r && x.s===d.id);
                const isSel = selected && selected.r===r && selected.s===d.id;
                
                // èƒŒæ™¯
                let cls = "triangle-base";
                if(isSel) cls += " selected";
                if(isDemon) cls += " demon-room-bg";
                const poly = drawPoly(groups.bg, d.pts, cls);
                poly.onclick = () => { 
                    selected = {r, s:d.id}; 
                    render(); // é‡ç»˜é€‰ä¸­æ€
                };

                // çº¿è·¯
                const ctr = centroid(d.pts);
                const ro = shard.rot / 120;
                drawBridge(groups.lines, ctr, mid(d.pts[0],d.pts[1]), COLORS[shard.edges[(0-ro+3)%3]]);
                drawBridge(groups.lines, ctr, mid(d.pts[1],d.pts[2]), COLORS[shard.edges[(1-ro+3)%3]]);
                drawBridge(groups.lines, ctr, mid(d.pts[2],d.pts[0]), COLORS[shard.edges[(2-ro+3)%3]]);
                
                // èŠ‚ç‚¹
                const n = document.createElementNS("http://www.w3.org/2000/svg","circle");
                n.setAttribute("cx",ctr.x); n.setAttribute("cy",ctr.y); n.setAttribute("class","joint-node");
                groups.lines.appendChild(n);
                
                // ç©å®¶
                const playersHere = localState.players.filter(p => p.alive && p.r===r && p.s===d.id);
                playersHere.forEach((p, idx) => {
                     const off = playersHere.length > 1 ? (idx*10)-5 : 0;
                     const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
                     dot.setAttribute("cx", ctr.x + off); dot.setAttribute("cy", ctr.y + off);
                     dot.setAttribute("class", "player-dot");
                     dot.style.fill = p.color;
                     // å¦‚æœæ˜¯è‡ªå·±ï¼ŒåŠ ä¸ªç™½åœˆ
                     if(p.id === socket.id) dot.setAttribute("stroke-width", "4");
                     groups.players.appendChild(dot);
                });
            });
        }
    }

    function updateUI() {
        const s = localState;
        const myP = s.players.find(p => p.id === socket.id);
        const currentP = s.players[s.turnIdx];
        const isMyTurn = currentP && currentP.id === socket.id;
function updateUI() {
    const s = localState;
    if(!s) return;

    // ... (ä¿ç•™ä¹‹å‰çš„ä»£ç )

    // --- æ–°å¢ï¼šå¤„ç†æ¸¸æˆç»“æŸ ---
    const modal = document.getElementById('game-over-modal');
    const resText = document.getElementById('result-text');
    const resDesc = document.getElementById('result-desc');

    if (s.phase === 'GAMEOVER') {
        modal.style.display = 'flex';
        if (s.gameResult === 'WIN') {
            resText.innerText = "å°å°å®Œæˆ";
            resText.className = "result-title win";
            resDesc.innerText = "ä½ ä»¬æˆåŠŸåœ¨æ¶é­”çš„è¿½å‡»ä¸‹å­˜æ´»äº† 10 å›åˆï¼";
        } else {
            resText.innerText = "å…¨å†›è¦†æ²¡";
            resText.className = "result-title lose";
            resDesc.innerText = `åœ¨ç¬¬ ${s.turnCount} å›åˆï¼Œæœ€åçš„å¸Œæœ›ç†„ç­äº†...`;
        }
    } else {
        modal.style.display = 'none'; // æ¸¸æˆä¸­éšè—å¼¹çª—
    }
    
    // å¦‚æœå›åˆ° LOBBYï¼Œä¹Ÿè¦ç¡®ä¿å¼¹çª—å…³é—­
    if (s.phase === 'LOBBY') {
        document.getElementById('login-modal').style.display = 'none'; // å·²ç»ç™»å½•è¿‡äº†
        document.getElementById('start-btn').style.display = (s.players[0].id === socket.id) ? 'block' : 'none';
        document.getElementById('room-info').innerText = "æˆ¿é—´é‡ç½®ï¼Œç­‰å¾…å¼€å§‹...";
    }
}

// æ–°å¢å‡½æ•°
function requestRestart() {
    socket.emit('restartGame');
}
        // æˆ¿é—´ä¿¡æ¯
        const info = document.getElementById('room-info');
        if(s.phase === 'LOBBY') {
            info.innerText = `å¤§å…ä¸­ (${s.players.length}/5äºº)`;
            // å¦‚æœæˆ‘æ˜¯ç¬¬0ä¸ªäººï¼Œæ˜¾ç¤ºå¼€å§‹æŒ‰é’®
            if(s.players.length > 0 && s.players[0].id === socket.id) {
                document.getElementById('start-btn').style.display = 'block';
            }
        } else if (s.phase === 'SETUP') {
            info.innerText = 'æŠ•æ·é˜¶æ®µ';
            document.getElementById('start-btn').style.display = 'none';
            // æ˜¾ç¤ºéª°å­é€»è¾‘
            const diceLayer = document.getElementById('setup-layer');
            const isMyRoll = (s.setupStep < s.players.length && s.players[s.setupStep].id === socket.id);
            // æ¶é­”æŠ•æ·æƒç»™æˆ¿ä¸»(P0)
            const isDemonRoll = (s.setupStep >= s.players.length && s.players[0].id === socket.id);
            
            diceLayer.style.display = (isMyRoll || isDemonRoll) ? 'block' : 'none';
        } else {
            info.innerText = `å›åˆ: ${currentP.name}`;
            document.getElementById('setup-layer').style.display = 'none';
        }

        // ç©å®¶åˆ—è¡¨
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        s.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `player-card ${s.turnIdx===i ? 'active' : ''} ${p.id===socket.id ? 'me' : ''}`;
            div.style.borderLeftColor = p.color;
            if(!p.alive) div.style.opacity = 0.3;
            div.innerHTML = `${p.name} <span style="float:right">HP:${p.hp} AP:${p.ap}</span>`;
            list.appendChild(div);
        });

        // æŒ‰é’®çŠ¶æ€
        const btns = ['btn-rot', 'btn-mov', 'btn-swap', 'btn-end'];
        btns.forEach(bid => {
            const btn = document.getElementById(bid);
            btn.disabled = !(s.phase === 'PLAYING' && isMyTurn);
        });
    }

    // SVG Utils
    function g(s){const e=document.createElementNS("http://www.w3.org/2000/svg","g");s.appendChild(e);return e}
    function drawPoly(p,pts,c){const e=document.createElementNS("http://www.w3.org/2000/svg","polygon");e.setAttribute("points",pts.map(i=>`${i.x},${i.y}`).join(" "));e.setAttribute("class",c);p.appendChild(e);return e}
    function drawBridge(p,a,b,c){const l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",a.x);l.setAttribute("y1",a.y);l.setAttribute("x2",b.x);l.setAttribute("y2",b.y);l.setAttribute("class","bridge-line");l.style.stroke=c;p.appendChild(l)}
    function pc(a,r=300){return{x:r*Math.cos(a),y:r*Math.sin(a)}}
    function mid(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2}}
    function centroid(pts){return{x:(pts[0].x+pts[1].x+pts[2].x)/3,y:(pts[0].y+pts[1].y+pts[2].y)/3}}
</script>


<div id="game-over-modal">
    <div id="result-text" class="result-title">VICTORY</div>
    <div id="result-desc" style="font-size: 20px; color: #aaa;">åšæŒåˆ°äº†ç¬¬ 10 å›åˆ</div>
    <button class="restart-btn" onclick="requestRestart()">å†æ¥ä¸€å±€</button>
</div>
</body>
</html>